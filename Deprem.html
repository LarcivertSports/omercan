<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Canlı Deprem İzleyici — AFAD + Kandilli</title>

<!-- Tailwind (CDN) -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<style>
  #map { height:60vh; min-height:320px; border-radius:8px; }
  .quake-item { cursor:pointer; }
  .status { min-height:1rem; }
</style>
</head>
<body class="bg-slate-900 text-slate-100 antialiased">
  <div class="max-w-6xl mx-auto p-4">
    <header class="flex flex-col sm:flex-row justify-between gap-4 mb-4 items-start sm:items-center">
      <div>
        <h1 class="text-2xl font-bold">Canlı Deprem İzleyici</h1>
        <p class="text-sm text-slate-400">AFAD + Kandilli verileri — harita ve liste</p>
      </div>

      <div class="flex gap-2 items-center w-full sm:w-auto">
        <label class="text-sm text-slate-300">Kaynak:</label>
        <select id="sourceSelect" class="rounded px-2 py-1 bg-slate-800 text-white">
          <option value="both" selected>AFAD + Kandilli</option>
          <option value="afad">AFAD</option>
          <option value="kandilli">Kandilli</option>
        </select>

        <label class="text-sm text-slate-300 ml-2">Min Mag:</label>
        <input id="minMag" type="number" step="0.1" min="0" value="0" class="w-16 px-2 py-1 rounded bg-slate-800 text-white">

        <button id="refreshBtn" class="ml-3 px-3 py-1 bg-emerald-500 text-black rounded font-semibold">Yenile</button>
        <button id="autoToggle" class="ml-1 px-2 py-1 bg-slate-700 rounded text-sm">Otomatik: Kapalı</button>
        <button id="btnFullscreen" title="Haritayı tam ekranda aç" class="ml-1 px-2 py-1 bg-slate-700 rounded text-sm">⤢</button>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <section class="lg:col-span-2 space-y-3">
        <div id="map" aria-label="Deprem haritası" role="region"></div>
        <div class="flex gap-2 text-sm text-slate-400 items-center">
          <div>Otomatik yenileme: <span id="autoIntervalLabel">30s</span></div>
          <div class="ml-auto status text-sm text-yellow-300" id="statusMessage"></div>
        </div>
      </section>

      <aside class="lg:col-span-1">
        <div class="bg-slate-800 rounded p-3 h-[60vh] overflow-auto" id="listContainer" aria-live="polite">
          <h2 class="font-semibold mb-2">Depremler</h2>
          <div id="quakeList" class="space-y-2 text-sm"></div>
        </div>
      </aside>
    </main>

    <footer class="mt-4 text-xs text-slate-500">
      <p>Not: AFAD & Kandilli verileri halka açıktır. Kandilli verisi için proxy gereklidir (CORS kısıtlaması).</p>
    </footer>
  </div>

<script>
/* ====== AYARLAR ====== */
// Kandilli proxy URL'sini buraya yaz.
// Eğer backend'i localde çalıştırıyorsan örn: 'http://localhost:3000/api/kandilli'
// Eğer çalıştırmadıysan 'kandilli' seçeneği hata verir; o durumda "AFAD" seç.
const KANDILLI_PROXY = 'http://localhost:3000/api/kandilli'; // <-- gerekli ise değiştir

const AFAD_POST_URL = 'https://deprem.afad.gov.tr/EventData/GetEventsByFilter';

/* ====== DOM ====== */
const sourceSelect = document.getElementById('sourceSelect');
const minMagInput = document.getElementById('minMag');
const refreshBtn = document.getElementById('refreshBtn');
const autoToggle = document.getElementById('autoToggle');
const btnFullscreen = document.getElementById('btnFullscreen');
const quakeListEl = document.getElementById('quakeList');
const statusEl = document.getElementById('statusMessage');
const autoIntervalLabel = document.getElementById('autoIntervalLabel');

/* ====== UYGULAMA DURUMLARI ====== */
let map, markersGroup;
let autoTimer = null;
let autoInterval = 30000; // 30s
autoIntervalLabel.textContent = (autoInterval/1000) + 's';

/* ====== Yardımcılar ====== */
function setStatus(text, isError=false){
  statusEl.textContent = text;
  statusEl.className = 'status text-sm ' + (isError ? 'text-red-400' : 'text-yellow-300');
}
function fmtDate(ts){
  if(!ts) return '—';
  const d = new Date(ts);
  return d.toLocaleString();
}

/* ====== Harita başlat ====== */
function initMap(){
  map = L.map('map').setView([39.0,35.0], 5);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap'
  }).addTo(map);
  markersGroup = L.layerGroup().addTo(map);
}

/* ====== AFAD çekme ====== */
async function fetchAfad(startIso=null, endIso=null){
  // Varsayılan: son 7 gün
  const now = new Date();
  const start = startIso || new Date(now.getTime() - (7*24*3600*1000)).toISOString();
  const end = endIso || now.toISOString();

  const body = {
    EventSearchFilterList: [
      { FilterType: 8, Value: start },
      { FilterType: 9, Value: end }
    ],
    Skip: 0,
    Take: 500,
    SortDescriptor: { field: "eventDate", dir: "desc" }
  };

  const res = await fetch(AFAD_POST_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if(!res.ok) throw new Error('AFAD çekilemedi: ' + res.status);
  const j = await res.json();
  const items = j.Items || j.Data || j || [];
  return (items || []).map(it => ({
    source: 'afad',
    id: it.eventId || it.Id || null,
    datetime: it.eventDate || it.occurrenceDate || null,
    lat: parseFloat(it.latitude || it.Latitude || it.Lat),
    lon: parseFloat(it.longitude || it.Longitude || it.Lon),
    mag: parseFloat(it.magnitude || it.Magnitude || it.Mag),
    depth: parseFloat(it.depth || it.Depth),
    place: it.locationName || it.location || it.place || (it.cityName ? `${it.cityName} ${it.locationName||''}` : '')
  }));
}

/* ====== Kandilli proxy çekme ====== */
async function fetchKandilli(){
  const res = await fetch(KANDILLI_PROXY);
  if(!res.ok) throw new Error('Kandilli proxy çekilemedi: ' + res.status);
  const j = await res.json();
  if(!j.ok) throw new Error('Kandilli proxy hata: ' + (j.error||'unknown'));
  return (j.events || []).map(it => ({
    source: it.source || 'kandilli',
    id: it.id || null,
    datetime: it.datetime || (it.date && it.time ? `${it.date}T${it.time}Z` : null),
    lat: it.lat,
    lon: it.lon,
    mag: it.mag,
    depth: it.depth,
    place: it.place || it.raw
  }));
}

/* ====== Görselleştirme ====== */
function clearMap(){
  markersGroup.clearLayers();
}
function renderMap(events){
  clearMap();
  if(!events.length) return;
  const latlngs = [];
  events.forEach(ev => {
    if(typeof ev.lat !== 'number' || typeof ev.lon !== 'number') return;
    const circle = L.circleMarker([ev.lat, ev.lon], {
      radius: Math.max(3, (ev.mag || 0) * 3),
      fillColor: ev.mag >= 5 ? '#ff4d4f' : ev.mag >= 4 ? '#ff7a45' : '#ffd666',
      color: '#111',
      weight: 0.5,
      fillOpacity: 0.9
    });
    const popup = `<b>${ev.place || '—'}</b><br>Mag: ${ev.mag ?? '—'} • Depth: ${ev.depth ?? '—'} km<br>${ev.datetime ? fmtDate(ev.datetime) : ''}<br>Source: ${ev.source}`;
    circle.bindPopup(popup);
    circle.addTo(markersGroup);
    latlngs.push([ev.lat, ev.lon]);
  });
  if(latlngs.length) map.fitBounds(latlngs, { padding:[30,30] });
}

function renderList(events){
  quakeListEl.innerHTML = '';
  events.forEach(ev => {
    const div = document.createElement('div');
    div.className = 'quake-item p-2 rounded bg-slate-700/40';
    div.innerHTML = `
      <div class="flex justify-between">
        <div class="font-semibold text-sm">${ev.place || '—'}</div>
        <div class="text-sm">${ev.mag ?? '—'}</div>
      </div>
      <div class="text-xs text-slate-400">${ev.datetime ? fmtDate(ev.datetime) : ''} • ${ev.depth ?? '—'} km • ${ev.source}</div>
    `;
    div.addEventListener('click', ()=> { if(ev.lat && ev.lon) map.setView([ev.lat, ev.lon], Math.max(map.getZoom(),6)); });
    quakeListEl.appendChild(div);
  });
}

/* ====== Toplayıcı & Filtre ====== */
async function gatherAndRender(){
  setStatus('Veriler çekiliyor...');
  try {
    const source = sourceSelect.value;
    const minMag = parseFloat(minMagInput.value) || 0;

    const promises = [];
    if(source === 'afad' || source === 'both') promises.push(fetchAfad());
    if(source === 'kandilli' || source === 'both') promises.push(fetchKandilli());

    const results = await Promise.allSettled(promises);
    let events = [];
    results.forEach(r => { if(r.status === 'fulfilled') events = events.concat(r.value); });

    // normalize & filter
    events = events.filter(e => e && typeof e.lat === 'number' && typeof e.lon === 'number' && (e.mag === null || e.mag >= minMag));

    // parse datetime numeric for sorting
    events.forEach(e => e._t = e.datetime ? new Date(e.datetime).getTime() : 0);
    events.sort((a,b) => (b._t||0) - (a._t||0));

    // limit for performance
    events = events.slice(0, 1000);

    renderMap(events);
    renderList(events);
    setStatus(`Görüntülenen: ${events.length} (min mag ${minMag})`);
  } catch(err){
    console.error(err);
    setStatus('Veri çekilirken hata: ' + (err.message||err), true);
  }
}

/* ====== Olaylar ====== */
refreshBtn.addEventListener('click', gatherAndRender);

autoToggle.addEventListener('click', ()=>{
  if(autoTimer){
    clearInterval(autoTimer); autoTimer = null;
    autoToggle.textContent = 'Otomatik: Kapalı';
    setStatus('Otomatik yenileme kapandı.');
  } else {
    autoTimer = setInterval(gatherAndRender, autoInterval);
    autoToggle.textContent = 'Otomatik: Açık';
    setStatus('Otomatik yenileme açık ('+ (autoInterval/1000) +'s).');
  }
});

btnFullscreen.addEventListener('click', ()=>{
  const el = document.getElementById('map');
  if(!document.fullscreenElement) el.requestFullscreen?.();
  else document.exitFullscreen?.();
});

document.addEventListener('keydown', (e)=>{
  if(e.key === 'r' || e.key === 'R') gatherAndRender();
  if(e.key === 'f' || e.key === 'F') btnFullscreen.click();
});

/* ====== Başlangıç ====== */
initMap();
gatherAndRender();

/* reagents */
feedSelect?.addEventListener?.('change', gatherAndRender);
minMagInput?.addEventListener?.('change', gatherAndRender);

</script>
</body>
</html>
